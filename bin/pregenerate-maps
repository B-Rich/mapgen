#!/usr/bin/python

import os, sys, re
import json

app_dir = os.path.abspath(__file__ + '/../..')
sys.path.append(os.path.join(app_dir, 'lib'))

from xcsoar.mapgen.generator import Generator
from xcsoar.mapgen.georect import GeoRect
from xcsoar.mapgen.downloader import Downloader
from xcsoar.mapgen.util import slurp

def main():
    dir_data = os.path.join(app_dir, 'data')
    config = Downloader(dir_data).retrieve('maps.config.js')
    config = re.sub(r'var\s+MAPS\s+=\s+|;', '', slurp(config))
    maps = json.loads(config)
    for name, bounds in maps.items():
        output_file = name + '.xcm'
        left   = bounds[0]
        bottom = bounds[1]
        right  = bounds[2]
        top    = bounds[3]
        generator = Generator(dir_data=dir_data,
                              dir_temp='/tmp/mapgen-{}'.format(os.getpid()))
        generator.set_bounds(GeoRect(left, right, top, bottom))
        generator.add_information_file(output_file)
        generator.add_topology()
        generator.add_terrain(9.0)
        generator.create(output_file)
        generator.cleanup()

if __name__ == '__main__':
    main()
